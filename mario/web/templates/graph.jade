//- 
    Copyright (c) 2014 10X Technologies, Inc. All rights reserved.
    
    Main UI for mario runner.

doctype html
html(ng-app="app" ng-controller="MarioGraphCtrl")
    head
        title [[.InstanceName]] / [[.Psid]] [[.Pname]]
        meta(name="apple-mobile-web-app-capable" content="yes")
        meta(name="apple-mobile-web-app-status-bar-style" content="black-translucent")
        link(rel="stylesheet" href="/css/bootstrap.min.css")
        link(rel="stylesheet" href="/css/main.css")
        script(src="/js/d3.v3.min.js")
        script(src="/js/dagre-d3.min.js")
        script(src="/js/angular.min.js")
        script(src="/js/ui-bootstrap-tpls-0.10.0.min.js")
        script(src="/js/lodash.min.js")
        script(src="/js/moment.min.js")
        script(src="/js/ngClip.js")
        script(src="/js/ZeroClipboard.min.js")

    body
        header.navbar.navbar-inverse.navbar-fixed-top(ng-class="{admin: adminstyle}")
            .navbar-header 
                .navbar-brand
                    a(href="{{urlprefix}}" style="color:#555") 10
                        span.logo-color X
                        | &nbsp;[[.InstanceName]]
                    | &nbsp;/ [[.Psid]] / [[.Pname]]
                    span(ng-if="adminstyle")
                        | &nbsp;(
                        a.admin-exit(href="/") exit admin mode
                        | )
        #graph(style="margin-left: 10px; margin-top: 60px")
            svg(width="750px" height="1000px")
                g#top(transform="translate(5,5) scale(1.0)")
        #details(ng-show="node")
            h4#stagename
                a(href="#") {{node.name}}                
                | {{node.type}} 
            
            div.alert.alert-danger.fixed(ng-show="node.error")
                div 
                    b Failed in {{node.error.fqname.substr(node.fqname.length+1)}}
                    br
                    |{{node.error.summary}}
                    br
                    br
                    a(ng-show="showLog==false" ng-click="showLog=true") show details
                    a(ng-show="showLog==true" ng-click="showLog=false") hide details
                    pre#metadata(ng-show="showLog")
                        button.close(type="button" ng-click="showLog=false") &times;
                        | {{node.error.log}}
        
            h5 Details
            table.table#info
                tr
                    td(style="width: 85px") State
                    td 
                        span.minibox(ng-class="node.state") {{node.state}}
                        button.btn.btn-default.btn-xs(ng-if="node.state == 'failed' && showRestart && admin" ng-click="restart()" style="margin-left: 10px") Restart
                tr
                    td FQName
                    td {{node.fqname}}
                tr
                    td Path
                    td 
                        button.btn.btn-default.btn-xs(type="button" clip-copy="copyToClipboard()")
                            span.glyphicon.glyphicon-paperclip
                        span.copyable {{node.path}}
                        span.copyable-display {{node.path | shorten}}
                tr(ng-if="node.type=='stage'")
                    td {{node.stagecodeLang}}
                    td 
                        button.btn.btn-default.btn-xs(type="button" clip-copy="copyToClipboard()")
                            span.glyphicon.glyphicon-paperclip
                        span.copyable {{node.stagecodePath}}
                        span.copyable-display {{node.stagecodePath | shorten}}
                tr
                    td(style="vertical-align: top") Sweeps
                    td
                        table
                            tr(ng-repeat="binding in node.sweepbindings") 
                                td {{binding.id}}&nbsp;&nbsp;
                                td 
                                    span.glyphicon.glyphicon-transfer &nbsp;
                                td {{binding.value | shorten}}

            h5 Sweeping
            table.table
                tr
                    td(style="width: 85px") Forks
                    td(colspan="5")
                        .btn-group
                            button.btn.btn-default(type="button" ng-model="$parent.forki" ng-repeat="fork in node.forks" btn-radio="fork.index") {{fork.index}}
                tr
                    td(style="width: 85px") State
                    td 
                        span.minibox(ng-class="node.forks[forki].state") {{node.forks[forki].state}}
                tr
                    td Permute
                    td(colspan="5")
                        table
                            tr(ng-repeat="(key, value) in node.forks[forki].argPermute")
                                td {{key}}
                                td &nbsp;=&nbsp;
                                td {{value | shorten}}
                tr
                    td Metadata
                    td(colspan="5")
                        span(ng-repeat="name in node.forks[forki].metadata.names") &nbsp;
                            a(ng-click="selectMetadata('fork', name, node.forks[forki].metadata.path)") {{name}}
                            | &nbsp;
                        pre#metadata(ng-show="mdviews['fork'].length")
                            button.close(type="button" ng-click="mdviews['fork']=''") &times;
                            | {{mdviews.fork}}

                tr
                    td Split 
                    td(colspan="5")
                        span(ng-repeat="name in node.forks[forki].split_metadata.names") &nbsp;
                            a(ng-click="selectMetadata('split', name, node.forks[forki].split_metadata.path)") {{name}}
                            | &nbsp;
                        pre#metadata(ng-show="mdviews.split.length")
                            button.close(type="button" ng-click="mdviews.split=''") &times;
                            | {{mdviews.split}}

                tr
                    td Join 
                    td(colspan="5")
                        span(ng-repeat="name in node.forks[forki].join_metadata.names") &nbsp;
                            a(ng-click="selectMetadata('join', name, node.forks[forki].join_metadata.path)") {{name}}
                            | &nbsp;
                        pre#metadata(ng-show="mdviews.join.length")
                            button.close(type="button" ng-click="mdviews.join=''") &times;
                            | {{mdviews.join}}

                tr(ng-repeat-start="(bindtype, bindings) in node.forks[forki].bindings").active
                    th(colspan="3") {{bindtype}} Bindings
                    th Source
                    th Value
                tr(ng-repeat="bnd in bindings")
                    td.tight(style="text-align: right")
                        i {{bnd.type}}
                    td.tight {{bnd.id}}
                    td.tight =
                    td
                        span(ng-class="[bnd.mode=='reference'?'minibox':'',nodes[bnd.node].state]") {{bnd.node}}
                            span(ng-if="bnd.mode=='reference'") \#{{bnd.matchedFork}}
                    td
                        span(ng-if="bnd.waiting") 
                            i.pending waiting
                        span(ng-if="!bnd.waiting && bnd.value==null") null
                        button.btn.btn-default.btn-xs(ng-if="bnd.value!=null" type="button" clip-copy="copyToClipboard()" style="vertical-align: top")
                            span.glyphicon.glyphicon-paperclip
                        span.copyable(ng-if="bnd.value!=null") {{bnd.value}}
                        span.copyable-display(ng-if="bnd.value!=null") {{bnd.value | shorten}}
                tr(ng-repeat-end)
                
            h5 Chunking
            table.table 
                tr
                    td(style="width: 85px") Chunks
                    td
                        .btn-group
                            button.btn.btn-default(ng-class="chunk.state" type="button" ng-model="$parent.chunki" ng-repeat="chunk in node.forks[forki].chunks" btn-radio="chunk.index") {{chunk.index}}
                tr
                    td(style="width: 85px") State
                    td 
                        span.minibox(ng-class="node.forks[forki].chunks[chunki].state") {{node.forks[forki].chunks[chunki].state}}
                tr
                    td Chunk Def
                    td
                        table
                            tr(ng-repeat="(key, value) in node.forks[forki].chunks[chunki].chunkDef")
                                td {{key}}
                                td &nbsp;=&nbsp;
                                td 
                                    button.btn.btn-default.btn-xs(type="button" clip-copy="copyToClipboard()")
                                        span.glyphicon.glyphicon-paperclip
                                    span.copyable {{value}}
                                    span.copyable-display {{value | shorten}}
                tr
                    td Metadata
                    td(colspan="5")
                        span(ng-repeat="name in node.forks[forki].chunks[chunki].metadata.names") &nbsp; 
                            a(ng-click="selectMetadata('chunk', name, node.forks[forki].chunks[chunki].metadata.path)") {{name}}
                            | &nbsp;
                        pre#metadata(ng-show="mdviews.chunk.length")
                            button.close(type="button" ng-click="mdviews.chunk=''") &times;
                            | {{mdviews.chunk}}

    script
        | container = '[[.Container]]';
        | pname = '[[.Pname]]';
        | psid = '[[.Psid]]';
        | admin = [[.Admin]];
        | adminstyle = [[.AdminStyle]];
    script(src="/graph.js")
